{% extends "base.html" %}

{% block head %}
<title>Asistente IA - HealthMind Analytics</title>
<style>
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
    }
    
    .chat-box {
        height: 400px;
        max-height: 60vh;
        overflow-y: auto;
        border: 2px solid #BDC3C7;
        border-radius: 16px;
        padding: 20px;
        background: linear-gradient(135deg, #FAFAFA 0%, #F5F5F5 100%);
        margin-bottom: 20px;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .message {
        margin-bottom: 15px;
        padding: 14px 18px;
        border-radius: 16px;
        max-width: 80%;
        word-wrap: break-word;
        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        line-height: 1.6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .message strong {
        font-weight: 600;
        color: #2C3E50;
    }
    
    .message em {
        font-style: italic;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .user-message {
        background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
        color: white;
        margin-left: auto;
        text-align: right;
    }
    
    .ai-message {
        background-color: white;
        border: 2px solid #ECF0F1;
        margin-right: auto;
        color: #2C3E50;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 15px;
        background: white;
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    .loading.active {
        display: block;
    }
    
    .spinner-border-sm {
        width: 1.2rem;
        height: 1.2rem;
        border-color: #1ABC9C;
        border-right-color: transparent;
    }
    
    .input-group {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-radius: 16px;
        overflow: hidden;
        border: 2px solid #BDC3C7;
    }
    
    .input-group input {
        border: none;
        padding: 15px 20px;
        background-color: white;
    }
    
    .input-group button {
        border: none;
        padding: 15px 30px;
        background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .input-group button:hover {
        background: linear-gradient(135deg, #16A085 0%, #1ABC9C 100%);
        transform: scale(1.02);
    }
    
    .message-header {
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .timestamp {
        font-size: 0.7rem;
        opacity: 0.6;
        margin-top: 8px;
        font-weight: 500;
    }
    
    .example-questions {
        margin-bottom: 20px;
        padding: 1rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    .example-btn {
        margin: 5px;
        font-size: 0.85rem;
        border: 2px solid #1ABC9C;
        color: #1ABC9C;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .example-btn:hover {
        background: linear-gradient(135deg, #1ABC9C 0%, #16A085 100%);
        color: white;
        border-color: #1ABC9C;
        transform: translateY(-2px);
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
        .chat-container {
            padding: 0 10px;
        }
        
        .chat-box {
            height: 300px;
            max-height: 50vh;
            padding: 15px;
        }
        
        .message {
            max-width: 90%;
            font-size: 0.9rem;
        }
        
        .example-btn {
            font-size: 0.75rem;
            margin: 3px;
            padding: 5px 10px;
        }
        
        .input-group input {
            padding: 12px 15px;
            font-size: 0.9rem;
        }
        
        .input-group button {
            padding: 12px 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="card shadow">
        <div class="card-header text-white">
            <h4 class="mb-1">
                <i class="fas fa-robot me-2"></i>Asistente Inteligente
            </h4>
            <small style="opacity: 0.9;">Consulta los datos en lenguaje natural y obtén insights al instante</small>
        </div>
        <div class="card-body">
            <!-- Preguntas de ejemplo -->
            <div class="example-questions">
                <h6 class="mb-3" style="color: #2C3E50; font-weight: 600;">
                    <i class="fas fa-lightbulb me-2" style="color: #1ABC9C;"></i>Preguntas de ejemplo
                </h6>
                <button class="btn btn-sm example-btn" onclick="setQuestion(this)">
                    ¿Cuántos pacientes hay en total?
                </button>
                <button class="btn btn-sm example-btn" onclick="setQuestion(this)">
                    ¿Cuál es el promedio de días de estancia?
                </button>
                <button class="btn btn-sm example-btn" onclick="setQuestion(this)">
                    ¿Qué comunidad tiene más ingresos?
                </button>
                <button class="btn btn-sm example-btn" onclick="setQuestion(this)">
                    ¿Cuántos hombres y mujeres hay?
                </button>
                <button class="btn btn-sm example-btn" onclick="setQuestion(this)">
                    ¿Cuál es el coste total de todos los ingresos?
                </button>
            </div>
            
            <!-- Chat box -->
            <div class="chat-box" id="chatBox">
                <div class="text-center text-muted">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>Haz una pregunta sobre los datos de salud mental</p>
                </div>
            </div>
            
            <!-- Loading indicator -->
            <div class="loading" id="loading">
                <div class="spinner-border text-primary spinner-border-sm me-2" role="status"></div>
                <span class="text-muted">Procesando tu pregunta...</span>
            </div>
            
            <!-- Input -->
            <div class="input-group">
                <input 
                    type="text" 
                    class="form-control" 
                    id="userInput" 
                    placeholder="Escribe tu pregunta aquí..."
                    onkeypress="handleKeyPress(event)"
                >
                <button class="btn" type="button" onclick="sendMessage()">
                    <i class="fas fa-paper-plane me-1"></i>Enviar
                </button>
            </div>
        </div>
    </div>
    
    <!-- Información adicional -->
    <div class="alert alert-warning mt-3" style="border-left: 4px solid #F39C12; background-color: #FEF9E7;">
        <i class="fas fa-exclamation-triangle me-2" style="color: #F39C12;"></i>
        <strong style="color: #2C3E50;">Advertencia:</strong> 
        <span style="color: #2C3E50;">Las respuestas son generadas por inteligencia artificial generativa 
        y pueden no ser completamente exactas. Verifica la información cuando sea crítica.</span>
    </div>
</div>

<script>
    function setQuestion(button) {
        document.getElementById('userInput').value = button.textContent.trim();
        document.getElementById('userInput').focus();
    }
    
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }
    
    function processMarkdown(text) {
        // Convertir negritas: **texto** a <strong>texto</strong>
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // Convertir cursivas: *texto* a <em>texto</em>
        text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
        
        // Convertir saltos de línea a <br>
        text = text.replace(/\n/g, '<br>');
        
        return text;
    }
    
    function addMessage(text, isUser) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
        
        const now = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        // Procesar markdown solo para mensajes de IA
        const processedText = isUser ? text : processMarkdown(text);
        
        let content = `
            <div class="message-header">
                <i class="fas fa-${isUser ? 'user' : 'robot'} me-1"></i>
                ${isUser ? 'Tú' : 'Asistente IA'}
            </div>
            <div>${processedText}</div>
            <div class="timestamp">${now}</div>
        `;
        
        messageDiv.innerHTML = content;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    
    async function sendMessage() {
        const input = document.getElementById('userInput');
        const question = input.value.trim();
        
        if (!question) return;
        
        // Clear initial message if exists
        const chatBox = document.getElementById('chatBox');
        if (chatBox.children[0]?.classList.contains('text-center')) {
            chatBox.innerHTML = '';
        }
        
        // Add user message
        addMessage(question, true);
        input.value = '';
        
        // Show loading
        const loading = document.getElementById('loading');
        loading.classList.add('active');
        
        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ question: question })
            });
            
            const data = await response.json();
            
            if (data.error) {
                addMessage(`❌ Error: ${data.error}`, false);
            } else {
                addMessage(data.answer, false);
            }
        } catch (error) {
            addMessage('❌ Error al procesar tu pregunta. Por favor, intenta de nuevo.', false);
            console.error('Error:', error);
        } finally {
            loading.classList.remove('active');
        }
    }
</script>
{% endblock %}
