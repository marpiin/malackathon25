{% extends "base.html" %}

{% block head %}
<style>
    .table-container {
        background: var(--white);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: var(--shadow);
    }

    .table {
        margin-bottom: 0;
    }

    .table thead th {
        background: var(--primary-color);
        color: var(--white);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 1rem;
        border: none;
        white-space: nowrap;
    }

    .table tbody td {
        padding: 1rem;
        vertical-align: middle;
        color: var(--text-dark);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .table tbody tr:hover {
        background-color: rgba(26, 188, 156, 0.05);
        transform: scale(1.005);
        transition: all 0.2s ease;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .pagination {
        margin-top: 1.5rem;
        margin-bottom: 0;
    }

    .pagination .page-link {
        border-radius: 8px;
        margin: 0 4px;
        color: var(--accent-color);
        border: 2px solid var(--border-color);
        font-weight: 500;
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease;
    }

    .pagination .page-item.active .page-link {
        background: var(--accent-color);
        border-color: var(--accent-color);
        color: var(--white);
        box-shadow: 0 4px 12px rgba(26, 188, 156, 0.3);
    }

    .pagination .page-link:hover:not(.active) {
        background-color: var(--accent-color);
        color: var(--white);
        border-color: var(--accent-color);
        transform: translateY(-2px);
    }

    .table-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 1rem;
        background: rgba(26, 188, 156, 0.05);
        border-radius: 10px;
    }

    .records-info {
        font-size: 0.9rem;
        color: var(--text-medium);
        font-weight: 500;
    }

    .per-page-selector {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .per-page-selector label {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-medium);
        font-weight: 500;
    }

    .per-page-selector select {
        width: auto;
        padding: 0.4rem 0.75rem;
    }

    @media (max-width: 768px) {
        .table-info {
            flex-direction: column;
            gap: 1rem;
        }

        .table-responsive {
            font-size: 0.85rem;
        }

        .table thead th,
        .table tbody td {
            padding: 0.75rem 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-6 mb-2">
            <i class="fas fa-table text-primary me-2"></i>
            Tabla de Datos
        </h1>
        <p class="text-muted">Exploraci√≥n detallada de registros de salud mental</p>
    </div>
</div>

<!-- Filtros -->
<div class="filter-section">
    <div class="filter-title">
        <i class="fas fa-filter"></i>
        Filtros de B√∫squeda
    </div>
    <form id="filterForm">
        <div class="row g-3">
            <div class="col-md-3">
                <label for="comunidad" class="form-label">
                    <i class="fas fa-map-marker-alt me-1"></i>Comunidad
                </label>
                <select class="form-select" id="comunidad" name="comunidad">
                    <option value="">Todas</option>
                    {% for comunidad in comunidades %}
                    <option value="{{ comunidad }}">{{ comunidad }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="sexo" class="form-label">
                    <i class="fas fa-venus-mars me-1"></i>G√©nero
                </label>
                <select class="form-select" id="sexo" name="sexo">
                    <option value="">Todos los g√©neros</option>
                    {% for s in sexos %}
                    <option value="{{ s }}">
                        {% if s == 'M' or s == 'Masculino' or s == 'Hombre' %}
                            üë® {{ s }}
                        {% elif s == 'F' or s == 'Femenino' or s == 'Mujer' %}
                            üë© {{ s }}
                        {% else %}
                            ‚ößÔ∏è {{ s }}
                        {% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="categoria" class="form-label">
                    <i class="fas fa-tag me-1"></i>Categor√≠a
                </label>
                <select class="form-select" id="categoria" name="categoria">
                    <option value="">Todas</option>
                    {% for categoria in categorias %}
                    <option value="{{ categoria }}">{{ categoria }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <label for="fecha_inicio" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Desde
                </label>
                <input type="date" class="form-control" id="fecha_inicio" name="fecha_inicio">
            </div>
            <div class="col-md-2">
                <label for="fecha_fin" class="form-label">
                    <i class="fas fa-calendar me-1"></i>Hasta
                </label>
                <input type="date" class="form-control" id="fecha_fin" name="fecha_fin">
            </div>
        </div>
        <div class="row mt-3">
            <div class="col">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search me-2"></i>Buscar
                </button>
                <button type="button" class="btn btn-outline-primary" id="btnLimpiar">
                    <i class="fas fa-undo me-2"></i>Limpiar
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Tabla -->
<div class="table-container mt-4">
    <div class="table-info">
        <div class="records-info">
            <i class="fas fa-info-circle me-1"></i>
            Mostrando <strong id="recordsStart">0</strong> - <strong id="recordsEnd">0</strong> de <strong id="recordsTotal">0</strong> registros
        </div>
        <div class="per-page-selector">
            <label for="perPage">
                <i class="fas fa-list me-1"></i>Registros por p√°gina:
            </label>
            <select class="form-select form-select-sm" id="perPage">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
            </select>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr id="tableHeaders"></tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="100" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3 text-muted">Cargando datos...</p>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <nav>
        <ul class="pagination justify-content-center" id="pagination"></ul>
    </nav>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let perPage = 10;

    function loadTable() {
        const formData = new FormData(document.getElementById('filterForm'));
        formData.append('page', currentPage);
        formData.append('per_page', perPage);
        const params = new URLSearchParams(formData);

        fetch(`/api/table?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('tableBody').innerHTML = `
                        <tr>
                            <td colspan="100" class="text-center py-5">
                                <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                                <p class="text-muted">${data.error}</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                updateTable(data);
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('tableBody').innerHTML = `
                    <tr>
                        <td colspan="100" class="text-center py-5">
                            <i class="fas fa-times-circle text-danger fa-3x mb-3"></i>
                            <p class="text-muted">Error al cargar los datos</p>
                        </td>
                    </tr>
                `;
            });
    }

    function updateTable(data) {
        // Actualizar informaci√≥n de registros
        const start = (currentPage - 1) * perPage + 1;
        const end = Math.min(start + data.items.length - 1, data.total);
        document.getElementById('recordsStart').textContent = data.items.length > 0 ? start : 0;
        document.getElementById('recordsEnd').textContent = end;
        document.getElementById('recordsTotal').textContent = data.total;

        // Actualizar headers
        if (data.items.length > 0) {
            const headers = Object.keys(data.items[0]);
            document.getElementById('tableHeaders').innerHTML = headers
                .map(h => `<th>${h}</th>`)
                .join('');

            // Actualizar body
            document.getElementById('tableBody').innerHTML = data.items
                .map(item => `
                    <tr>
                        ${headers.map(h => `<td>${item[h] !== null ? item[h] : '-'}</td>`).join('')}
                    </tr>
                `)
                .join('');
        } else {
            document.getElementById('tableBody').innerHTML = `
                <tr>
                    <td colspan="100" class="text-center py-5">
                        <i class="fas fa-inbox text-muted fa-3x mb-3"></i>
                        <p class="text-muted">No se encontraron registros</p>
                    </td>
                </tr>
            `;
        }

        // Actualizar paginaci√≥n
        updatePagination(data.pages, data.current_page);
    }

    function updatePagination(totalPages, currentPageNum) {
        const pagination = document.getElementById('pagination');
        let html = '';

        // Bot√≥n anterior
        html += `
            <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPageNum - 1}); return false;">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;

        // P√°ginas
        const maxVisible = 5;
        let startPage = Math.max(1, currentPageNum - Math.floor(maxVisible / 2));
        let endPage = Math.min(totalPages, startPage + maxVisible - 1);

        if (endPage - startPage < maxVisible - 1) {
            startPage = Math.max(1, endPage - maxVisible + 1);
        }

        if (startPage > 1) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>`;
            if (startPage > 2) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === currentPageNum ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>
            `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a></li>`;
        }

        // Bot√≥n siguiente
        html += `
            <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPageNum + 1}); return false;">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;

        pagination.innerHTML = html;
    }

    function changePage(page) {
        currentPage = page;
        loadTable();
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    document.getElementById('filterForm').addEventListener('submit', function(e) {
        e.preventDefault();
        currentPage = 1;
        loadTable();
    });

    document.getElementById('btnLimpiar').addEventListener('click', function() {
        document.getElementById('filterForm').reset();
        currentPage = 1;
        loadTable();
    });

    document.getElementById('perPage').addEventListener('change', function() {
        perPage = parseInt(this.value);
        currentPage = 1;
        loadTable();
    });

    // Cargar datos iniciales
    loadTable();
</script>
{% endblock %}
